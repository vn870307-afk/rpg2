// lib/screens/game_screen.dart

import 'package:flutter/material.dart';
import 'package:rpg/controllers/game_controller.dart';
import 'package:rpg/models/player.dart';
import 'package:rpg/screens/main_screen.dart';
import 'package:rpg/screens/attribute_allocation_screen.dart';
import 'package:rpg/widgets/fillIn_answer_field.dart';
import 'package:rpg/models/battle_log_entry.dart';

class GameScreen extends StatefulWidget {
  final GameController game;
  final Player player;
  final VoidCallback onGameOver;

  const GameScreen({
    super.key,
    required this.game,
    required this.player,
    required this.onGameOver,
  });

  @override
  State<GameScreen> createState() => _GameScreenState();
}

class _GameScreenState extends State<GameScreen> with SingleTickerProviderStateMixin {
  bool loaded = false;
  final ScrollController _logScrollController = ScrollController();

  late AnimationController _animationController;
  late Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();
    _setOnDeath();
    widget.game.addListener(_handleGameUpdate);

    _animationController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 800),
    )..repeat(reverse: true);

    _scaleAnimation = Tween<double>(begin: 1.0, end: 1.05).animate(
      CurvedAnimation(parent: _animationController, curve: Curves.easeInOut),
    );

    loaded = true;
  }

  void _handleGameUpdate() {
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (_logScrollController.hasClients) {
        _logScrollController.animateTo(
          _logScrollController.position.maxScrollExtent,
          duration: const Duration(milliseconds: 200),
          curve: Curves.easeOut,
        );
      }
    });
    setState(() {});
  }

  @override
  void dispose() {
    widget.game.removeListener(_handleGameUpdate);
    _logScrollController.dispose();
    _animationController.dispose();
    super.dispose();
  }

  void _setOnDeath() {
    widget.game.player.onDeath = () {
      WidgetsBinding.instance.addPostFrameCallback((_) {
        showDialog(
          context: context,
          barrierDismissible: false,
          builder: (context) {
            return AlertDialog(
              title: const Text("üíÄ ÈÅäÊà≤ÁµêÊùü"),
              content: const Text("‰Ω†ÁöÑ HP Ê≠∏Èõ∂‰∫ÜÔºÅ"),
              actions: [
                ElevatedButton(
                  onPressed: () {
                    Navigator.of(context).pop();
                    Navigator.pushReplacement(
                      context,
                      PageRouteBuilder(
                        pageBuilder: (context, animation, secondaryAnimation) => const MainScreen(),
                        transitionsBuilder: (context, animation, secondaryAnimation, child) =>
                            FadeTransition(opacity: animation, child: child),
                        transitionDuration: const Duration(milliseconds: 500),
                      ),
                    );
                  },
                  child: const Text("ÂõûÂà∞‰∏ªÁï´Èù¢"),
                ),
              ],
            );
          },
        );
      });
    };
  }

  Widget _buildLogEntry(BattleLogEntry entry) {
    final color = entry.getColor();
    final messageWithIcon = entry.toString();
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 2),
      child: Text(
        messageWithIcon,
        style: TextStyle(
          color: color,
          fontSize: 16,
          fontFamily: 'KaiTi', // ÂÅáË®≠ÊÇ®ÂºïÂÖ•‰∫ÜÊ•∑È´îÊàñÊ∞¥Â¢®È¢®Ê†ºÂ≠óÈ´î
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    if (!loaded) {
      return const Scaffold(
        body: Center(child: CircularProgressIndicator()),
      );
    }

    final event = widget.game.currentEvent;
    final monster = event.type == "monster" ? widget.game.currentMonster : null;
    final bool hasUnallocatedPoints = widget.player.unallocatedPoints > 0;
        
    // Êñ∞Â¢ûÔºöÂÆöÁæ©ÂÆπÂô®ÂØ¨Â∫¶Â∏∏Êï∏ÔºåÊñπ‰æøË®àÁÆóÈÅ∏È†ÖÂØ¨Â∫¶
    final double questionContainerWidth = MediaQuery.of(context).size.width * 0.85;
    const double questionContainerPadding = 12.0;


    return Scaffold(
      // Êï¥È´îËÉåÊôØËâ≤Ë™øÔºöÊ∑°ÈõÖÁöÑÁÅ∞ÁôΩÊàñÊ∑∫ËóçÁ∂†ÔºåÊ®°Êì¨ÂÆ£Á¥ô
      backgroundColor: const Color.fromARGB(255, 245, 245, 240), // Ê∑∫Á±≥ÁôΩÔºåÂÆ£Á¥ôËâ≤
      body: SafeArea(
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.center,
            children: [
              // ====================== Áé©ÂÆ∂Â±¨ÊÄßÂçÄ ======================
              Container(
                padding: const EdgeInsets.all(8),
                // Ê∞¥Â¢®È¢®Ê†ºÁöÑÊ∑°ÈõÖÂ∫ïËâ≤
                color: const Color.fromARGB(255, 220, 225, 230), 
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Wrap(
                      spacing: 16,
                      runSpacing: 4,
                      children: [
                        Text("Ë°ÄÈáè: ${widget.player.hp} / ${widget.player.maxhp}",
                            style: const TextStyle(fontSize: 14, fontWeight: FontWeight.bold, color: Color.fromARGB(255, 50, 50, 50))),
                        Text("Á≠âÁ¥ö: ${widget.player.lv}",
                            style: const TextStyle(fontSize: 14, fontWeight: FontWeight.bold, color: Color.fromARGB(255, 50, 50, 50))),
                        Text("Á∂ìÈ©óÂÄº: ${widget.player.exp}",
                            style: const TextStyle(fontSize: 14, fontWeight: FontWeight.bold, color: Color.fromARGB(255, 50, 50, 50))),
                        Text("SANÂÄº: ${widget.player.SAN.toStringAsFixed(1)}%",
                            style: const TextStyle(fontSize: 14, fontWeight: FontWeight.bold, color: Color.fromARGB(255, 50, 50, 50))),
                      ],
                    ),
                    const SizedBox(height: 5),
                    Row(
                      children: [
                        ScaleTransition(
                          scale: hasUnallocatedPoints ? _scaleAnimation : const AlwaysStoppedAnimation(1.0),
                          child: ElevatedButton(
                            onPressed: () async {
                              await Navigator.push(
                                context,
                                MaterialPageRoute(
                                  builder: (context) => AttributeAllocationScreen(player: widget.player),
                                ),
                              );
                              setState(() {});
                            },
                            style: ElevatedButton.styleFrom(
                              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                              minimumSize: const Size(80, 30),
                              backgroundColor:
                                  hasUnallocatedPoints ? const Color.fromARGB(255, 150, 50, 50) : const Color.fromARGB(255, 180, 180, 180), // ÊöóÁ¥ÖÊàñÊ∑±ÁÅ∞
                              foregroundColor: Colors.white,
                              elevation: hasUnallocatedPoints ? 8 : 2,
                            ),
                            child: const Text("ËÉΩÂäõÂÄº", style: TextStyle(fontSize: 14, fontWeight: FontWeight.bold)),
                          ),
                        ),
                        const SizedBox(width: 12),
                        Text(
                          "(Ââ©È§òÂèØÂàÜÈÖç: ${widget.player.unallocatedPoints})",
                          style: TextStyle(
                            fontSize: 12,
                            fontWeight: FontWeight.bold,
                            color: hasUnallocatedPoints ? const Color.fromARGB(255, 150, 50, 50) : const Color.fromARGB(255, 50, 50, 50),
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 12),

              // ====================== Êà∞È¨•Á¥ÄÈåÑÂçÄ ======================
              Container(
                width: double.infinity,
                height: 300,
                decoration: BoxDecoration(
                  color: const Color.fromARGB(255, 30, 30, 30), // Êõ¥Ê∑±ÁöÑÂ¢®Ëâ≤ËÉåÊôØ
                  borderRadius: BorderRadius.circular(8), // ÂúìËßíÂèØ‰ª•Â∞è‰∏ÄÈªû
                  border: Border.all(color: const Color.fromARGB(255, 100, 100, 100), width: 1), // Á¥∞ËÜ©ÁöÑÈÇäÊ°Ü
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(alpha: 0.2),
                      blurRadius: 6,
                      offset: const Offset(2, 2),
                    ),
                  ],
                ),
                padding: const EdgeInsets.all(8),
                child: AnimatedBuilder(
                  animation: widget.game,
                  builder: (context, _) {
                    return ListView.builder(
                      controller: _logScrollController,
                      itemCount: widget.game.battleLog.length,
                      itemBuilder: (context, index) {
                        return _buildLogEntry(widget.game.battleLog[index]);
                      },
                    );
                  },
                ),
              ),

              const SizedBox(height: 16),

              // ====================== ‰∫ã‰ª∂ÂçÄ (Story Event) ======================
              if (event.type == "story") ...[
                Text(event.text ?? "",
                    textAlign: TextAlign.center,
                    style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: Color.fromARGB(255, 50, 50, 50))),
                const SizedBox(height: 20),
                if (event.options != null && event.options!.isNotEmpty)
                  ...List.generate(event.options!.length, (i) {
                    return Padding(
                      padding: const EdgeInsets.symmetric(vertical: 4),
                      child: ElevatedButton(
                        onPressed: () => setState(() => widget.game.selectStoryOption(i)),
                        // Ê∞¥Â¢®È¢®Ê†ºÊåâÈàï
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.transparent, // ÈÄèÊòéËÉåÊôØ
                          foregroundColor: const Color.fromARGB(255, 50, 50, 50), // Â¢®Ëâ≤ÊñáÂ≠ó
                          side: const BorderSide(color: Color.fromARGB(255, 100, 100, 100), width: 1), // Á¥∞ÈÇäÊ°Ü
                          elevation: 0, // ÁÑ°Èô∞ÂΩ±
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                        ),
                        child: Text(event.options![i], style: const TextStyle(fontSize: 14, fontFamily: 'KaiTi')),
                      ),
                    );
                  })
                else
                  ElevatedButton(
                    onPressed: () => setState(() => widget.game.nextEvent()),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color.fromARGB(255, 120, 120, 120), // Â¢®Ëâ≤ÊåâÈàï
                      foregroundColor: Colors.white,
                      elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                    ),
                    child: const Text("ÁπºÁ∫å", style: TextStyle(fontSize: 14, fontFamily: 'KaiTi')),
                  ),
              ] 
              
              // ====================== ‰∫ã‰ª∂ÂçÄ (Monster Event) ======================
              else if (event.type == "monster" && monster != null) ...[
                // „Äê‚ú® Ê∞¥Â¢®È¢®Ê†ºÁöÑÊÄ™Áâ©Âç°Áâá„Äë
                Container(
                  width: double.infinity, // ‰ΩøÁî®ÂÆöÁæ©ÁöÑÂØ¨Â∫¶
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(10),
                    // Ê®°Êì¨Ê∞¥Â¢®ÊöàÊüìÁöÑÊº∏Â±§
                    gradient: LinearGradient(
                      begin: Alignment.topCenter,
                      end: Alignment.bottomCenter,
                      colors: [
                        const Color.fromARGB(255, 230, 230, 225), // Ê∑∫ÁÅ∞ÁôΩ
                        const Color.fromARGB(255, 200, 200, 195), // ËºÉÊ∑±ÁÅ∞ÁôΩ
                      ],
                    ),
                    // Ê®°Êì¨Áï´‰ΩúÁöÑÈÇäÊ°ÜËàáÈô∞ÂΩ±
                    border: Border.all(color: const Color.fromARGB(255, 80, 80, 80), width: 1.5), // Ê∑∫Â¢®Ëâ≤ÈÇäÊ°Ü
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withValues(alpha: 0.2),
                        blurRadius: 5,
                        offset: const Offset(3, 3), 
                      ),
                    ],
                  ),
                  child: Padding(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.center,
                      children: [
                        Text(monster.name,
                            textAlign: TextAlign.center,
                            style: const TextStyle(
                                fontSize: 20, fontWeight: FontWeight.w900, color: Color.fromARGB(255, 40, 40, 40), fontFamily: 'KaiTi')), // Â¢®Ëâ≤Â≠óÈ´î
                        
                        const Divider(height: 20, thickness: 1.5, indent: 30, endIndent: 30, color: Color.fromARGB(255, 150, 150, 150)), // Ê∑∫Â¢®Á∑öÊ¢ù

                        // ‚ú® ‰ΩøÁî® Wrap/Row Â∞áÂ±¨ÊÄßÈ°ØÁ§∫Âú®‰∏ÄË°å
                        Wrap(
                          alignment: WrapAlignment.center, // ËÆìÂ±¨ÊÄßÂ±Ö‰∏≠È°ØÁ§∫
                          spacing: 18, // Â±¨ÊÄß‰πãÈñìÁöÑÊ∞¥Âπ≥ÈñìË∑ù
                          children: [
                            Text("HP: ${monster.hp}", 
                                style: const TextStyle(fontSize: 16, color: Color.fromARGB(255, 60, 120, 60), fontWeight: FontWeight.bold, fontFamily: 'KaiTi')), // Á∂†Ëâ≤Â¢®
                            
                            Text("ATK: ${monster.atk}", 
                                style: const TextStyle(fontSize: 16, color: Color.fromARGB(255, 60, 60, 120), fontWeight: FontWeight.bold, fontFamily: 'KaiTi')), // ËóçËâ≤Â¢®
                            
                            Text(
                              "ÂõûÂêà: ${monster.turnCounter}",
                              style: TextStyle(
                                fontSize: 16,
                                fontWeight: monster.turnCounter <= 1 ? FontWeight.w900 : FontWeight.bold,
                                color: monster.turnCounter <= 1 ? const Color.fromARGB(255, 150, 50, 50) : const Color.fromARGB(255, 40, 40, 40), // ÈÆÆÁ¥ÖÊàñÂ¢®Ëâ≤
                                fontFamily: 'KaiTi',
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),
                ),
                
                const SizedBox(height: 20),

                // „Äê‚ú® Ê∞¥Â¢®È¢®Ê†ºÁöÑ‰ΩúÁ≠îÂçÄÂ§ñÊ°Ü (ÂïèÈ°å + Á≠îÊ°à/ÈÅ∏È†Ö)„Äë
                if (event.question != null)
                  Container(
                    width: double.infinity,
                    padding: const EdgeInsets.all(questionContainerPadding),
                    decoration: BoxDecoration(
                      // ÊüîÂíåÁöÑÂÆ£Á¥ôÊº∏Â±§
                      gradient: const LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: [
                          Color.fromARGB(255, 250, 250, 245), // Ê∑∫ÂÆ£Á¥ôËâ≤
                          Color.fromARGB(255, 240, 240, 230), // Á®çÊ∑±ÂÆ£Á¥ôËâ≤
                        ],
                      ),
                      borderRadius: BorderRadius.circular(10),
                      border: Border.all(color: const Color.fromARGB(255, 80, 80, 80), width: 1.5), // Â¢®Ëâ≤ÈÇäÊ°Ü
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black.withValues(alpha: 0.2),
                          blurRadius: 5,
                          offset: const Offset(3, 3), 
                        ),
                      ],
                    ),
                    child: Column(
                      children: [
                        // ÂïèÈ°åÊñáÂ≠ó
                       
                        
                        // Â°´Á©∫È°å (ÂÅáË®≠ ZiWeiFillInAnswerField ÂÖßÈÉ®‰πüË™øÊï¥‰∫ÜÈ¢®Ê†º)
                        if (event.answerKeys != null && event.answerKeys!.isNotEmpty)
                          ZiWeiFillInAnswerField(
                            event: event,
                            onSubmit: (answer) {
                              widget.game.answerEvent(answer);
                              setState(() {
                                if (widget.game.currentMonster?.isDead ?? false) {
                                  widget.game.nextEvent();
                                } else {
                                  widget.game.assignRandomQuestionToMonster();
                                }
                              });
                            },
                          )
                        
                        // ÈÅ∏ÊìáÈ°å (‰∏ÄË°åÂÖ©ÈÅ∏È†Ö)
                        else if (event.options != null && event.options!.isNotEmpty)
                          Wrap(
                            spacing: 8,
                            runSpacing: 8,
                            alignment: WrapAlignment.center,
                            children: List.generate(event.options!.length, (i) {
                              // Ë®àÁÆóÊØèÂÄãÈÅ∏È†ÖÁöÑÂØ¨Â∫¶
                              final buttonWidth =
                                  (questionContainerWidth - questionContainerPadding * 2 - 8) / 2;
                                  
                              return SizedBox(
                                width: buttonWidth,
                                child: ElevatedButton(
                                  onPressed: () {
                                    widget.game.answerEvent(i);
                                    setState(() {
                                      if (widget.game.currentMonster?.isDead ?? false) {
                                        widget.game.nextEvent();
                                      } else {
                                        widget.game.assignRandomQuestionToMonster();
                                      }
                                    });
                                  },
                                  // Ê∞¥Â¢®È¢®Ê†ºÊåâÈàï
                                  style: ElevatedButton.styleFrom(
                                    backgroundColor: Colors.transparent, // ÈÄèÊòéËÉåÊôØ
                                    foregroundColor: const Color.fromARGB(255, 50, 50, 50), // Â¢®Ëâ≤ÊñáÂ≠ó
                                    side: const BorderSide(color: Color.fromARGB(255, 100, 100, 100), width: 1), // Á¥∞ÈÇäÊ°Ü
                                    elevation: 0, // ÁÑ°Èô∞ÂΩ±
                                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
                                  ),
                                  child: Text(event.options![i],
                                      style: const TextStyle(fontSize: 12, fontFamily: 'KaiTi'), // Ê∞¥Â¢®È¢®Ê†ºÂ≠óÈ´î
                                      textAlign: TextAlign.center,
                                      maxLines: 2,
                                      overflow: TextOverflow.ellipsis),
                                ),
                              );
                            }),
                          ),
                      ],
                    ),
                  ),
              ],
            ],
          ),
        ),
      ),
    );
  }
}